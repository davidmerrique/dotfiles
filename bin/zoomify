#!/usr/bin/env bash
#
# Zoooooomify.

set -e

echo ''

copy_images () {
  shopt -s nullglob

  if ! [ -z $1 ]; then
    rm -rf $1
    folder=$1
  else
    rm -rf zoom
    folder="zoom"
  fi

  mkdir $folder

  for file in *.tif; do
    echo $file

    mkdir -p $folder/${file%%.*}/TileGroup0

    declare -A sizes
    # sizes[size]=quality
    sizes[160]=90
    sizes[320]=85
    sizes[640]=85
    sizes[1280]=75
    sizes[2560]=65
    count=0

    sizes_indexes=( ${!sizes[@]} )
    IFS=$'\n' sizes_sorted=($(sort -n <<<"${sizes_indexes[*]}"))

    for i in "${sizes_sorted[@]}"; do
      echo $i ${sizes[$i]}
      gm convert \
      -size ${i}X${i} \
      -resize ${i}X${i}! \
      -format jpg \
      -strip \
      -interlace Plane \
      -quality ${sizes[$i]}% \
      -modulate 100,110 \
      $file \
      $folder/${file%%.*}/TileGroup0/${count}-0-0.jpg
      let count=count+1
    done

  done
}

copy_images $1
