#!/usr/bin/env bash
#
# Zoooooomify.

set -e

echo ''

notify() {
  message="$1"
  osascript -e "display notification \"$message\" with title \"Zoomify\""
}

shopt -s nullglob

notify "Process started"

rm -rf zoom
folder="zoom"

mkdir $folder

for file in *.tif; do
  echo $file

  mkdir -p $folder/${file%%.*}/TileGroup0

  sizes=()
  sizes[160]=90
  sizes[320]=85
  sizes[640]=85
  sizes[1280]=75
  sizes[2560]=65
  count=0

  sizes_indexes=( ${!sizes[@]} )
  IFS=$'\n' sizes_sorted=($(sort -n <<<"${sizes_indexes[*]}"))

  if [ $file == "BODY.tif" ]; then
    saturation=130
  else
    saturation=110
  fi

  for i in "${sizes_sorted[@]}"; do
    echo $i ${sizes[$i]}

    gm convert \
    -size ${i}X${i} \
    -resize ${i}X${i}! \
    -format jpg \
    -interlace Line \
    -quality ${sizes[$i]}% \
    $file \
    $folder/${file%%.*}/TileGroup0/${count}-0-0.jpg

    # -fuzz 5% \
    # -fill "#EBEBEB" \
    # -opaque white \

    if [ $file != "BODY.tif" ]; then
      gm mogrify \
      -strip \
      $folder/${file%%.*}/TileGroup0/${count}-0-0.jpg
    fi

    let count=count+1
  done

  notify "$file processed"

done

notify "Process complete"
